name: Khamsat Details Scraper (Monthly Auto)

on:
  schedule:
    - cron: '7 0 1 * *'  # Le 1er de chaque mois Ã  00h07 UTC
  workflow_dispatch:  # Permet lancement manuel
  repository_dispatch:
    types: [continue-details-scraping]

jobs:
  scrape-details:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # 5h50
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Chrome and ChromeDriver
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        wget -q https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
        rm google-chrome-stable_current_amd64.deb
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run details scraper
      id: scraping
      timeout-minutes: 340  # 5h40 - ArrÃªt avant le timeout du job
      run: python rac4.py
      continue-on-error: true
    
    - name: Commit and push results
      if: always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add categories/
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ”„ Update details data - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
    
    - name: Check if scraping is complete
      id: check_complete
      run: |
        python << 'EOF'
        import os
        import json
        import glob
        
        progress_dir = "categories/progress_details"
        resultats_dir = "categories/resultats"
        
        # Compte les fichiers CSV dans resultats
        csv_files = glob.glob(os.path.join(resultats_dir, "Resultats_*.csv"))
        
        total_services = 0
        processed_services = 0
        
        for csv_file in csv_files:
            filename = os.path.splitext(os.path.basename(csv_file))[0]
            progress_file = os.path.join(progress_dir, f"progress_{filename}.json")
            
            # Compte les lignes du CSV (services)
            with open(csv_file, 'r', encoding='utf-8-sig') as f:
                lines = len(f.readlines()) - 1
                total_services += lines
            
            # Compte les URLs traitÃ©es
            if os.path.exists(progress_file):
                with open(progress_file, 'r') as f:
                    processed = len(json.load(f))
                    processed_services += processed
        
        print(f"ðŸ“Š Progression: {processed_services}/{total_services}")
        
        if processed_services >= total_services:
            print("âœ… Scraping terminÃ© - Pas de relance!")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("complete=true\n")
        else:
            print("ðŸ”„ Scraping incomplet, relance nÃ©cessaire")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("complete=false\n")
        EOF
    
    - name: Trigger next run if incomplete
      if: steps.check_complete.outputs.complete == 'false'
      run: |
        echo "ðŸ”„ DÃ©clenchement du prochain run..."
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/dispatches \
          -d '{"event_type":"continue-details-scraping"}'
    
    - name: Final status report
      if: always()
      run: |
        if [ "${{ steps.check_complete.outputs.complete }}" == "true" ]; then
          echo "âœ… =========================================="
          echo "âœ… SCRAPING TERMINÃ‰ AVEC SUCCÃˆS"
          echo "âœ… Prochain lancement: 1er du mois suivant"
          echo "âœ… =========================================="
        else
          echo "ðŸ”„ Scraping en cours, relance automatique..."
        fi
